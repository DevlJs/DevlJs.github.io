<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<script></script>
	<meta id="viewport" name="viewport" content="target-densitydpi=device-dpi, width=640, user-scalable=no">
	<script>
		(function(isAndroid, viewport) {
			if (isAndroid && viewport) viewport.setAttribute("content", "target-densitydpi=" + (640 / window.screen.width * window.devicePixelRatio * 160) + ", width=640, user-scalable=no");
		})(/Android/i.test(navigator.userAgent), document.getElementById("viewport"));

	</script>
	<link rel="stylesheet" href="http://7xilp5.com1.z0.glb.clouddn.com/femina/ckone/style.css">
</head>

<body>
	<div id="page4" class="page" style="display: block;">
		<!-- 可编辑图片区域 -->
		<div id="preview">
			<canvas id="photo" width="330" height="572" style="touch-action: none; -webkit-user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></canvas>
			<!-- 底图 -->
			<div class="cover" style="background-image: url(http://case.incdc.com/femina/ckone/img/zine_1.png);"></div>
		</div>

		<!-- 上传按钮 -->
		<div id="drag-and-drop-zone" class="uploader" style="position: relative; border: none;">
			<div class="browser">
				<input type="file" name="files[]" accept="image/*" multiple="multiple" title="Click to add Images" ) style="position: relative;
				width: 125px;
		    height: 125px;
		    display: block;z-index: 11;
		    top: 30px;
		    position: absolute;
		    left: 50%;
		    margin-left: -62.5px;" />
			</div>
			<i id="photoIcon" style="background-image:url(http://7xojhs.com2.z0.glb.qiniucdn.com/p3_btn.png);
				width: 125px;
		    height: 125px;
		    display: block;
		    z-index: 10;
		    top: 30px;
		    position: absolute;
		    left: 50%;
		    margin-left: -62.5px;"></i>
		</div>
	</div>

	<!-- 上传组件-->
	<link rel="stylesheet" href="http://7xojhs.com2.z0.glb.qiniucdn.com/uploader.css" />
	<link rel="stylesheet" href="http://7xojhs.com2.z0.glb.qiniucdn.com/uploaderdemo.css" />

	<script src="http://7xojhs.com2.z0.glb.qiniucdn.com/jquery-1.10.2.js"></script>
	<!--拖动-->
	<script src="http://7xojhs.com2.z0.glb.qiniucdn.com/jquery-migrate-1.2.1.min.js"></script>
	<script type="text/javascript" src="http://7xojhs.com2.z0.glb.qiniucdn.com/demo-preview.min.js"></script>
	<script type="text/javascript" src="http://7xojhs.com2.z0.glb.qiniucdn.com/dmuploader.min.js"></script>


	<script src="http://7xilp5.com1.z0.glb.clouddn.com/femina/ckone/js/zepto.min.js"></script>
	<script src="http://7xilp5.com1.z0.glb.clouddn.com/femina/ckone/js/hammer.min.js"></script>
	<script>
		var User = {
			nickname: "-",
			avatar: "http://7xojhs.com2.z0.glb.qiniucdn.com/aditou.jpg"
		};
		(function($) {
			$.extend({
				"dragImg": function() {
					var v = 0,
						w = 430,
						x = 672,
						p = false,
						k = 0,
						l = undefined,
						g = true,
						b = 672,
						c = 1.4883720930232558,
						d = undefined,
						D = null,
						P = 430,
						y = new Image,
						S = {};
					y.src = User.avatar;

					y.onload = function() {
						v = k = 0, P = this.naturalWidth, x = this.naturalHeight, P / x > 430 / 672 && (w = Math.ceil(572 * P / x), v = (430 - w) / 2), b = w * x / P, s()

						//旋转
						Img.rotate("photo", 90);
					};



					var C = $("#photo").get(0);
					T = C.getContext("2d");
					C.width = w, C.height = b, T.fillStyle = "#FFFFFF";
					var S, _, I = new Hammer.Manager(C);
					$(".close").click(function() {
						$("#canvassPage").hide()
					});
					I.add(new Hammer.Pan),
						I.add(new Hammer.Pinch),
						I.on("panstart", function(a) {
							S = {
								x: v,
								y: k
							}
						}).on("panmove", function(a) {
							v = S.x + a.deltaX,
								k = S.y + a.deltaY,
								s()
						}).on("pinchstart", function(a) {
							_ = {
									width: w,
									height: b
								},
								S = {
									x: v,
									y: k
								}
						}).on("pinchmove", function(a) {
							w = Math.max(430, _.width * a.scale),
								b = w * x / P,
								v = S.x + (_.width - w) / 3,
								k = S.y + (_.height - b) / 2,
								s()
						});

					function s() {
						T.fillRect(0, 0, 430, 672),
							T.drawImage(y, 0, 0, P, x, v, k, w, b)
					}
				}
			});
		}($))
		var Img = function() {
			var T$ = function(id) {
				return document.getElementById(id);
			}
			var ua = navigator.userAgent,
				isIE = /msie/i.test(ua) && !window.opera;
			var i = 0,
				sinDeg = 0,
				cosDeg = 0,
				timer = null;
			var rotate = function(target, degree) {
				target = T$(target);
				var orginW = target.clientWidth,
					orginH = target.clientHeight;
				clearInterval(timer);

				function run(angle) {
					if (isIE) { // IE
						cosDeg = Math.cos(angle * Math.PI / 180);
						sinDeg = Math.sin(angle * Math.PI / 180);
						with(target.filters.item(0)) {
							M11 = M22 = cosDeg;
							M12 = -(M21 = sinDeg);
						}
						target.style.top = (orginH - target.offsetHeight) / 2 + 'px';
						target.style.left = (orginW - target.offsetWidth) / 2 + 'px';
					} else if (target.style.MozTransform !== undefined) { // Mozilla
						target.style.MozTransform = 'rotate(' + angle + 'deg)';
					} else if (target.style.OTransform !== undefined) { // Opera
						target.style.OTransform = 'rotate(' + angle + 'deg)';
					} else if (target.style.webkitTransform !== undefined) { // Chrome Safari
						target.style.webkitTransform = 'rotate(' + angle + 'deg)';
					} else {
						target.style.transform = "rotate(" + angle + "deg)";
					}
				}

				timer = setInterval(function() {
					i += 10;
					run(i);
					if (i > degree - 1) {
						i = 0;
						clearInterval(timer);
					}
				}, 10);
			}
			return {
				rotate: rotate
			}
		}();

		$(function() {
			$.dragImg();
			$('#drag-and-drop-zone').dmUploader({
				url: 'http://image.rrliuxue.com/Upload.aspx',
				dataType: 'json',
				allowedTypes: 'image/*',
				onNewFile: function(id, file) {
					$.danidemo.addFile('#demo-files', id, file);
					if (typeof FileReader !== "undefined") {
						var reader = new FileReader();
						reader.onload = function(e) {
							User.avatar = e.target.result;
							$.dragImg();
						}
						reader.readAsDataURL(file);
					}
				}
			});

			//$("[type='file']").attr("style", "position: inherit;opacity:0.8;background-repeat: no-repeat;background-image:url(http://7xojhs.com2.z0.glb.qiniucdn.com/p3_btn.png)");
		});

	</script>

</body>

</html>
